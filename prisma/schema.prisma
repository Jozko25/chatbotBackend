generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id            String    @id @default(cuid())
  clerkUserId   String    @unique @map("auth0_sub")
  email         String    @unique
  name          String?
  avatarUrl     String?   @map("avatar_url")
  stripeCustomerId String? @unique @map("stripe_customer_id")

  // Subscription & limits
  plan          Plan      @default(FREE)
  messageLimit  Int       @default(50) @map("message_limit")
  messagesUsed  Int       @default(0) @map("messages_used")
  limitResetAt  DateTime  @default(now()) @map("limit_reset_at")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Relations
  chatbots      Chatbot[]
  apiKeys       ApiKey[]
  usageRecords  UsageRecord[]
  subscription  Subscription?
  integrations  Integration[]

  @@map("users")
}

enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

// ============================================
// SUBSCRIPTIONS & BILLING
// ============================================

model Subscription {
  id                   String   @id @default(cuid())
  userId               String   @unique @map("user_id")
  stripeCustomerId     String   @map("stripe_customer_id")
  stripeSubscriptionId String   @unique @map("stripe_subscription_id")
  status               String
  priceId              String   @map("price_id")
  currentPeriodEnd     DateTime? @map("current_period_end")
  cancelAtPeriodEnd    Boolean  @default(false) @map("cancel_at_period_end")

  // Timestamps
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

model StripeEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique @map("stripe_event_id")
  type          String
  objectId      String?  @map("object_id")
  livemode      Boolean  @default(false)
  processedAt   DateTime? @map("processed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([type])
  @@map("stripe_events")
}

// ============================================
// CHATBOT INSTANCES
// ============================================

model Chatbot {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")

  // Scraped website data
  name            String
  sourceUrl       String    @map("source_url")
  clinicData      Json      @map("clinic_data")
  rawContent      String?   @map("raw_content") @db.Text

  // Customizable AI settings
  systemPrompt    String?   @map("system_prompt") @db.Text
  customKnowledge String?   @map("custom_knowledge") @db.Text
  welcomeMessage  String?   @map("welcome_message")

  // Communication style
  communicationStyle CommunicationStyle @default(PROFESSIONAL) @map("communication_style")
  language        String    @default("auto") // auto, sk, cs, en, etc.
  customGreeting  String?   @map("custom_greeting") @db.Text

  // Notification settings
  notificationEmail   String?   @map("notification_email")
  notificationWebhook String?   @map("notification_webhook")
  notifyOnBooking     Boolean   @default(true) @map("notify_on_booking")
  notifyOnMessage     Boolean   @default(false) @map("notify_on_message")

  // Booking settings
  bookingEnabled      Boolean   @default(true) @map("booking_enabled")
  bookingFields       String[]  @default(["name", "email", "phone", "service", "preferredDate", "notes"]) @map("booking_fields")
  bookingPromptMessage String?  @map("booking_prompt_message") @db.Text

  // Page display restrictions
  pageDisplayMode     PageDisplayMode @default(ALL) @map("page_display_mode")
  allowedPages        String[]  @default([]) @map("allowed_pages")  // URL patterns for INCLUDE/EXCLUDE modes

  // Theme/customization
  theme           Json      @default("{}")

  // Status
  status          ChatbotStatus @default(ACTIVE)
  lastScrapedAt   DateTime  @map("last_scraped_at")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations   Conversation[]
  apiKeys         ApiKey[]
  usageRecords    UsageRecord[]
  bookingRequests BookingRequest[]
  integrations    Integration[]

  @@index([userId])
  @@index([sourceUrl])
  @@map("chatbots")
}

enum CommunicationStyle {
  PROFESSIONAL  // Formal, business-like
  FRIENDLY      // Warm, conversational
  CASUAL        // Relaxed, informal
  CONCISE       // Brief, to-the-point
}

enum PageDisplayMode {
  ALL           // Show on all pages
  INCLUDE       // Only show on pages matching allowedPages
  EXCLUDE       // Show on all pages except those matching allowedPages
}

enum ChatbotStatus {
  ACTIVE
  PAUSED
  DELETED
}

// ============================================
// CONVERSATIONS & MESSAGES
// ============================================

model Conversation {
  id            String    @id @default(cuid())
  chatbotId     String    @map("chatbot_id")

  // Session tracking (for embed widget)
  sessionId     String    @map("session_id")
  visitorIp     String?   @map("visitor_ip")
  visitorUserAgent String? @map("visitor_user_agent") @db.Text
  referrerUrl   String?   @map("referrer_url")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  chatbot       Chatbot   @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([chatbotId, sessionId])
  @@index([chatbotId])
  @@index([sessionId])
  @@map("conversations")
}

model Message {
  id              String    @id @default(cuid())
  conversationId  String    @map("conversation_id")

  role            MessageRole
  content         String    @db.Text

  // Token usage tracking
  promptTokens    Int?      @map("prompt_tokens")
  completionTokens Int?     @map("completion_tokens")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

enum MessageRole {
  user
  assistant
  system
}

// ============================================
// API KEYS (for embed widget authentication)
// ============================================

model ApiKey {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  chatbotId     String?   @map("chatbot_id")

  // Key data (store hashed, return prefix only)
  keyHash       String    @unique @map("key_hash")
  keyPrefix     String    @map("key_prefix")
  name          String    @default("Default Key")

  // Domain whitelist for security
  allowedDomains String[] @default([]) @map("allowed_domains")

  // Permissions & limits
  scopes        String[]  @default(["chat"])
  rateLimit     Int       @default(60) @map("rate_limit")

  // Status
  isActive      Boolean   @default(true) @map("is_active")
  lastUsedAt    DateTime? @map("last_used_at")
  expiresAt     DateTime? @map("expires_at")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatbot       Chatbot?  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([chatbotId])
  @@map("api_keys")
}

// ============================================
// USAGE TRACKING & ANALYTICS
// ============================================

model UsageRecord {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  chatbotId     String?   @map("chatbot_id")

  // Event data
  eventType     UsageEventType @map("event_type")

  // For message events
  promptTokens    Int?    @map("prompt_tokens")
  completionTokens Int?   @map("completion_tokens")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")

  // Date partition for efficient querying
  date          DateTime  @db.Date

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatbot       Chatbot?  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([chatbotId, date])
  @@index([eventType, date])
  @@map("usage_records")
}

enum UsageEventType {
  SCRAPE
  CHAT_MESSAGE
  EMBED_COPY
  WIDGET_LOAD
  BOOKING_REQUEST
}

// ============================================
// BOOKING REQUESTS
// ============================================

model BookingRequest {
  id              String    @id @default(cuid())
  chatbotId       String    @map("chatbot_id")
  conversationId  String?   @map("conversation_id")

  // Customer data collected from chat
  customerName    String?   @map("customer_name")
  customerEmail   String?   @map("customer_email")
  customerPhone   String?   @map("customer_phone")

  // Booking details
  service         String?
  preferredDate   String?   @map("preferred_date")
  preferredTime   String?   @map("preferred_time")
  notes           String?   @db.Text

  // All collected data as JSON (flexible)
  data            Json      @default("{}")

  // Status
  status          BookingStatus @default(PENDING)

  // Notification tracking
  notificationSent    Boolean   @default(false) @map("notification_sent")
  notificationSentAt  DateTime? @map("notification_sent_at")
  notificationError   String?   @map("notification_error")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  chatbot         Chatbot   @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([chatbotId])
  @@index([status])
  @@index([createdAt])
  @@map("booking_requests")
}

enum BookingStatus {
  PENDING     // Just submitted, not processed
  NOTIFIED    // Notification sent to business
  CONFIRMED   // Business confirmed the booking
  CANCELLED   // Booking was cancelled
  COMPLETED   // Booking was completed
}

// ============================================
// INTEGRATIONS (Google Calendar, etc.)
// ============================================

model Integration {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  chatbotId       String    @map("chatbot_id")

  // Integration type
  provider        IntegrationProvider

  // OAuth tokens (encrypted)
  accessToken     String    @map("access_token") @db.Text
  refreshToken    String?   @map("refresh_token") @db.Text
  tokenExpiresAt  DateTime? @map("token_expires_at")

  // Provider-specific settings
  calendarId      String?   @map("calendar_id")  // For Google Calendar: which calendar to use
  settings        Json      @default("{}")       // Additional provider settings

  // Status
  isConnected     Boolean   @default(true) @map("is_connected")
  lastSyncAt      DateTime? @map("last_sync_at")
  error           String?                        // Last error message if any

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatbot         Chatbot   @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@unique([chatbotId, provider])
  @@index([userId])
  @@index([chatbotId])
  @@index([provider])
  @@map("integrations")
}

enum IntegrationProvider {
  GOOGLE_CALENDAR
  // Future: CALENDLY, CAL_COM, OUTLOOK, etc.
}
